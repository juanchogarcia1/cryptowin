<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin • Crypto Win</title><link rel="icon" href="favicon.svg" type="image/svg+xml"><link rel="stylesheet" href="style.css"><script defer src="app.js"></script>
</head><body>
<header class='cw'>
  <button class="hamb" id="hamb" aria-label="Abrir menú"><span></span><span></span><span></span></button>
  <a class="brand" href="boards.html"><img src="logo-horizontal.svg" alt="CW" class="cw-logo"></a>
  <div style="width:40px"></div>
</header>
<div class="layout">
  <aside class="sidebar" id="drawer">
    <nav class="menu">
      <a href="boards.html">Tableros</a>
      <a href="referrals.html">Referidos</a>
      <a href="commissions.html">Comisiones</a>
      <a href="history.html">Historial</a>
      <a href="profile.html">Configuración</a>
      <a href="admin.html">Admin</a>
      <a href="index.html">Salir</a>
    </nav>
  </aside>
  <div class="content">
    
<section class='card'>
  <h2 style='margin:0'>Admin</h2>
  <p class='small'>Reporte de ingresos, pagos y saldo del sistema.</p>

  <div class='row' style='gap:8px;flex-wrap:wrap'>
    <label>Desde <input id='r-from' class='input' type='date' style='width:180px'></label>
    <label>Hasta <input id='r-to' class='input' type='date' style='width:180px'></label>
    <button class='btn' id='r-run'>Generar</button>
  </div>

  <div class='kpi-row' style='display:grid;gap:12px;grid-template-columns:repeat(4,minmax(0,1fr)); margin-top:12px'>
    <div class='kpi-card'><div class='kpi-title'>Ingresos netos</div><div class='kpi-value' id='r-ingresos'>$0.00</div></div>
    <div class='kpi-card'><div class='kpi-title'>Pagos en mesas</div><div class='kpi-value' id='r-mesas'>$0.00</div></div>
    <div class='kpi-card'><div class='kpi-title'>Pagos referidos (10%)</div><div class='kpi-value' id='r-refs'>$0.00</div></div>
    <div class='kpi-card'><div class='kpi-title'>Saldo sistema</div><div class='kpi-value' id='r-saldo'>$0.00</div></div>
  </div>

  <h3 style='margin:16px 0 6px'>Editor rápido de usuario</h3>
  <div class='row' style='gap:8px;flex-wrap:wrap'>
    <input class='input' id='u-email' placeholder='Email del usuario' style='width:240px'>
    <input class='input' id='u-wallet' placeholder='Wallet TRC20'>
    <button class='btn' id='u-save'>Guardar</button>
  </div>
</section>

<script>
(function(){
  function runReport(){
    // Demo calc: números mock
    const ingresos = 8191 * 10;   // netos
    const refs = 8190 * 1;        // 10% a referidos (menos el primero)
    const mesas = 10237.50;       // pagos pares (según nuestra regla)
    const saldo = ingresos - refs - mesas;
    document.getElementById('r-ingresos').textContent = '$' + ingresos.toFixed(2);
    document.getElementById('r-mesas').textContent = '$' + mesas.toFixed(2);
    document.getElementById('r-refs').textContent = '$' + refs.toFixed(2);
    document.getElementById('r-saldo').textContent = '$' + saldo.toFixed(2);
  }
  document.getElementById('r-run').onclick = runReport;
  runReport();

  document.getElementById('u-save').onclick = ()=> alert('Guardado (demo). Aquí conectaríamos PUT /admin/user');
})();
</script>

    <footer>© 2025 Crypto Win — Vista previa
<section class='card' id='resumen-mesas-admin'>
  <h3 style='margin:0 0 8px'>Resumen de Mesas (solo admin)</h3>
  <div class='small' style='margin-bottom:8px'>Totales calculados con la misma regla de la matriz x2 (pares pagan).</div>
  <div style='overflow:auto'>
    <table class='table' id='tabla-resumen-mesas'>
      <thead><tr><th>Mesa</th><th>Paga</th><th>Pago al usuario</th><th>Auto-ascenso</th><th>Total de la mesa</th><th>Personas requeridas</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>
<script>
(function(){
  function reqForLevel(level){ return Math.pow(2, level); }
  // Reutilizamos funciones globales si existen (de app.js)
  const priceForLevel = window.priceForLevel || function(level){ if(level===1) return 10; return 15 * Math.pow(2, level-2); };
  const payoutForLevel = window.payoutForLevel || function(level){ if(level % 2 !== 0) return 0; const price = priceForLevel(level); return 0.5 * price; };
  const tbody = document.querySelector('#tabla-resumen-mesas tbody');
  if(!tbody) return;
  const rows = [];
  for(let lvl=1; lvl<=12; lvl++){
    const paga = (lvl % 2 === 0);
    const pago = payoutForLevel(lvl);
    const reinv = (lvl<12) ? priceForLevel(lvl+1) : 0;
    const total = pago + reinv;
    const req = reqForLevel(lvl);
    rows.push(`<tr>
      <td>${lvl}</td>
      <td>${paga?'Sí':'No'}</td>
      <td>$${pago.toFixed(2)}</td>
      <td>$${reinv.toFixed(2)}</td>
      <td>$${total.toFixed(2)}</td>
      <td>${req.toLocaleString()}</td>
    </tr>`);
  }
  tbody.innerHTML = rows.join('');
})();
</script>

</footer>
  </div>
</div>
<div class="overlay" id="overlay"></div>
</body></html>
<section class='card' id='ops-admin'>
  <h3 style='margin:0 0 8px'>Operación — Retiros automáticos</h3>
  <div class='row' style='margin-bottom:8px'>
    <label>Día de retiro</label>
    <select class='input' id='cfg-day' style='width:160px'>
      <option value='1'>Lunes</option><option value='2'>Martes</option><option value='3'>Miércoles</option>
      <option value='4'>Jueves</option><option value='5'>Viernes</option><option value='6'>Sábado</option><option value='0'>Domingo</option>
    </select>
    <label>Hora (24h)</label>
    <input class='input' id='cfg-hour' style='width:120px' value='10:00'>
    <button class='btn' id='cfg-apply'>Aplicar</button>
    <span class='small' id='cfg-next'>Próxima corrida: —</span>
  </div>
  <div class='row'>
    <button class='btn' id='export-users'>Exportar usuarios CSV</button>
    <button class='btn' id='export-withdrawals'>Exportar retiros CSV</button>
    <button class='btn' id='view-audit'>Ver auditoría</button>
  </div>
  <div style='margin-top:8px; display:none' id='audit-box'>
    <div class='small'>Últimas acciones de administración:</div>
    <div style='overflow:auto; max-height:260px'>
      <table class='table' id='audit-table'><thead><tr><th>Fecha</th><th>Admin</th><th>Acción</th><th>Detalle</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</section>
<script>
(function(){
  const daySel = document.getElementById('cfg-day');
  const hourInp = document.getElementById('cfg-hour');
  const btnApply = document.getElementById('cfg-apply');
  const nextLbl = document.getElementById('cfg-next');
  const auditBox = document.getElementById('audit-box');
  const auditTable = document.querySelector('#audit-table tbody');

  function cronFrom(day, hhmm){
    const [h,m] = (hhmm||'10:00').split(':').map(x=>parseInt(x,10));
    return `0 ${m||0} ${h||10} * * ${day}`; // m h * * day
  }

  btnApply && (btnApply.onclick = async ()=>{
    const cron = cronFrom(daySel.value, hourInp.value);
    await fetch('/admin/config', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ paydayCron: cron })});
    nextLbl.textContent = 'Próxima corrida: configurada';
  });

  async function exportCSV(endpoint, filename){
    const r = await fetch(endpoint);
    const t = await r.text();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([t], {type:'text/csv'}));
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
  document.getElementById('export-users')?.addEventListener('click', ()=> exportCSV('/admin/export/users.csv','usuarios.csv'));
  document.getElementById('export-withdrawals')?.addEventListener('click', ()=> exportCSV('/admin/export/withdrawals.csv','retiros.csv'));

  document.getElementById('view-audit')?.addEventListener('click', async ()=>{
    const r = await fetch('/admin/audit?limit=100'); const j = await r.json();
    auditTable.innerHTML = (j.items||[]).map(x=>`<tr><td>${new Date(x.ts).toLocaleString()}</td><td>${x.admin||'-'}</td><td>${x.action}</td><td>${x.detail||''}</td></tr>`).join('');
    auditBox.style.display = 'block';
  });
})();
</script>
